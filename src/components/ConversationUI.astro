---
// src/components/ConversationUI.astro
// Fully functional conversation UI for The Soulforge Saga

import { gameStateManager } from '../game/stateManager.js';
import { conversationSystem } from '../game/conversationSystem.js';
---

<div id="conversation-ui" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
  <div class="glass-card w-full max-w-2xl max-h-[90vh] flex flex-col">
    <!-- Conversation header -->
    <div class="flex justify-between items-center p-4 border-b border-slate-700">
      <div class="flex items-center">
        <div class="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center mr-3">
          <i data-lucide="user" class="w-6 h-6"></i>
        </div>
        <div>
          <h3 class="text-xl font-bold" id="npc-name">NPC Name</h3>
          <div class="text-sm text-slate-400" id="npc-title">Role • Settlement</div>
        </div>
      </div>
      <button 
        class="glass-button secondary-button p-2"
        onclick="window.closeConversation()"
      >
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <!-- Conversation content -->
    <div class="flex-1 overflow-hidden flex flex-col">
      <!-- Dialogue history -->
      <div class="flex-1 overflow-y-auto p-4 pr-2" id="dialogue-history">
        <div class="text-center text-slate-500 py-8">
          <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
          <p>Memulai percakapan...</p>
        </div>
      </div>
      
      <!-- Response options -->
      <div class="p-4 border-t border-slate-700" id="response-options">
        <div class="space-y-2">
          <button 
            class="glass-button secondary-button w-full py-3 text-left hover:bg-slate-700/50 transition-colors"
            data-response-id="0"
            onclick="window.selectResponse(0)"
          >
            <i data-lucide="message-square" class="w-4 h-4 mr-2 inline"></i>
            Memulai percakapan dengan NPC ini...
          </button>
          <button 
            class="glass-button secondary-button w-full py-3 text-left hover:bg-slate-700/50 transition-colors"
            data-response-id="1"
            onclick="window.selectResponse(1)"
          >
            <i data-lucide="gift" class="w-4 h-4 mr-2 inline"></i>
            Saya ingin menawarkan bantuan.
          </button>
          <button 
            class="glass-button secondary-button w-full py-3 text-left hover:bg-slate-700/50 transition-colors"
            data-response-id="2"
            onclick="window.selectResponse(2)"
          >
            <i data-lucide="help-circle" class="w-4 h-4 mr-2 inline"></i>
            Apakah ada masalah yang bisa saya bantu?
          </button>
          <button 
            class="glass-button secondary-button w-full py-3 text-left hover:bg-slate-700/50 transition-colors"
            data-response-id="3"
            onclick="window.selectResponse(3)"
          >
            <i data-lucide="map" class="w-4 h-4 mr-2 inline"></i>
            Ceritakan tentang tempat ini.
          </button>
        </div>
      </div>
    </div>
    
    <!-- Conversation footer -->
    <div class="p-4 border-t border-slate-700 flex justify-between items-center">
      <div class="flex items-center">
        <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center mr-2">
          <i data-lucide="heart" class="w-4 h-4 text-red-500"></i>
        </div>
        <span class="text-sm" id="relationship-status">Hubungan: Netral</span>
      </div>
      <div class="text-sm text-slate-400" id="conversation-turn">
        Giliran NPC
      </div>
    </div>
  </div>
</div>

<script>
  let currentConversation = null;
  let conversationHistory = [];
  
  // Initialize conversation UI
  document.addEventListener('DOMContentLoaded', () => {
    // Add global conversation functions
    window.openConversation = function(npcId) {
      startConversation(npcId);
    };
    
    window.closeConversation = function() {
      const ui = document.getElementById('conversation-ui');
      if (ui) {
        ui.classList.add('hidden');
      }
      currentConversation = null;
      conversationHistory = [];
    };
    
    window.selectResponse = function(responseId) {
      if (currentConversation) {
        continueConversation(responseId);
      }
    };
    
    window.startConversation = function(npcId) {
      // In a real implementation, this would call the conversation system
      // For now, we'll simulate a conversation
      
      // Show conversation UI
      const ui = document.getElementById('conversation-ui');
      if (ui) {
        ui.classList.remove('hidden');
      }
      
      // Set NPC info
      document.getElementById('npc-name').textContent = 'Aldric Brightgold';
      document.getElementById('npc-title').textContent = 'Pedagang • Nexus Pusat yang Berdenyut';
      
      // Initialize conversation
      initializeSampleConversation();
    };
    
    window.continueConversation = function(responseId) {
      // Get selected response
      const responses = [
        "Halo! Senang bertemu denganmu. Apa yang membawamu ke Nexus Pusat?",
        "Ah, seorang yang dermawan! Kami selalu membutuhkan bantuan di sini.",
        "Ya, sebenarnya kami sedang menghadapi kekurangan sumber daya air bersih.",
        "Nexus Pusat adalah kota terbesar di wilayah ini. Kami dikenal dengan perdagangan dan teknologi."
      ];
      
      const npcResponses = [
        "Saya Aldric Brightgold, seorang pedagang di pasar utama. Saya menjual berbagai barang eksotis dari seluruh dunia.",
        "Oh, kami sangat berterima kasih atas tawaranmu. Setiap bantuan diperlukan.",
        "Ini masalah serius. Tanpa air bersih, warga kami bisa terkena wabah penyakit.",
        "Kota kami terletak di pusat Nexus, tempat energi dunia berdenyut paling kuat."
      ];
      
      // Add player response to history
      addToHistory('player', responses[responseId] || "...");
      
      // Add NPC response after a delay
      setTimeout(() => {
        const npcResponse = npcResponses[responseId] || "Itu pertanyaan yang menarik...";
        addToHistory('npc', npcResponse);
      }, 1000);
    };
    
    window.addToHistory = function(speaker, text) {
      const historyContainer = document.getElementById('dialogue-history');
      if (!historyContainer) return;
      
      // Create message element
      const messageElement = document.createElement('div');
      messageElement.className = `mb-4 ${speaker === 'player' ? 'text-right' : 'text-left'}`;
      
      messageElement.innerHTML = `
        <div class="${speaker === 'player' ? 'inline-block bg-indigo-500/20 px-4 py-2 rounded-lg rounded-br-none' : 'inline-block bg-slate-700 px-4 py-2 rounded-lg rounded-bl-none'}">
          <div class="font-bold text-sm mb-1 ${speaker === 'player' ? 'text-indigo-300' : 'text-slate-300'}">
            ${speaker === 'player' ? 'Kamu' : 'Aldric Brightgold'}
          </div>
          <div class="text-slate-100">${text}</div>
        </div>
      `;
      
      // Add to history
      historyContainer.appendChild(messageElement);
      
      // Scroll to bottom
      historyContainer.scrollTop = historyContainer.scrollHeight;
    };
    
    window.initializeSampleConversation = function() {
      const historyContainer = document.getElementById('dialogue-history');
      if (!historyContainer) return;
      
      // Clear history
      historyContainer.innerHTML = '';
      
      // Add initial NPC message
      setTimeout(() => {
        addToHistory('npc', "Halo, pendatang! Selamat datang di Nexus Pusat yang Berdenyut. Nama saya Aldric Brightgold, seorang pedagang di pasar utama. Apa yang membawamu ke kota kami?");
      }, 500);
    };
  });
  
  // Function to show notification
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
      type === 'success' ? 'bg-green-500' :
      type === 'error' ? 'bg-red-500' :
      type === 'info' ? 'bg-blue-500' :
      'bg-slate-700'
    } text-white max-w-md`;
    notification.textContent = message;
    
    // Add to document
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 3000);
  }
</script>